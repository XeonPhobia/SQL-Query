SELECT CAST(YEAR(EXAM_DATE) AS CHAR) + CAST(MONTH(EXAM_DATE) AS CHAR) as [DATO], COUNT(*) AS [NUMBER_EXAM], EXAM_MODALITY 
INTO _temp_e1
FROM DBO.EXAM 
WHERE CAST(YEAR(EXAM_DATE) AS CHAR) BETWEEN 2010 AND 2019
GROUP BY CAST(YEAR(EXAM_DATE) AS CHAR) + CAST(MONTH(EXAM_DATE) AS CHAR), CAST(YEAR(EXAM_DATE) AS CHAR), EXAM_MODALITY
ORDER BY CAST(YEAR(EXAM_DATE) AS CHAR), len(CAST(YEAR(EXAM_DATE) AS CHAR) + CAST(MONTH(EXAM_DATE) AS CHAR)), [DATO]

USE _temp_e1;
GO
SELECT distinct [EXAM_MODALITY] + ', ' FROM [temp_e1] for xml path('')

SELECT DATO, BI, CR, CT, DX, EC, ES, MG, MR, NM, OT, PR, PT, RF, SC, US, XA
  FROM 
	(SELECT DATO, NUMBER_EXAM, EXAM_MODALITY FROM temp_e1 
	) AS SourceTable
PIVOT
(
avg(NUMBER_EXAM)
FOR 
EXAM_MODALITY IN (BI, CR, CT, DX, EC, ES, MG, MR, NM, OT, PR, PT, RF, SC, US, XA)
) AS PivotTable
ORDER BY left(DATO, 4), len(DATO), DATO;
